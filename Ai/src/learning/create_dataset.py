# -*- coding: utf-8 -*-
import pandas as pd
import ast
import json

# ==========================================
# 1. 태그 매핑 규칙 (최적화 버전)
# ==========================================
TAG_MAPPING = {
    # ----------------------------------
    # [1] 맛 & 가격 (기본)
    # ----------------------------------
    '#맛집': ['맛있다', '존맛', '꿀맛', '야미', '최고', '맛집', '음식', '맛', '미쳤다'],
    '#가성비': ['가성비','저렴', '싸다', '착하다', '혜자', '합리적', '비싸지', '값싸'],
    '#양푸짐': ['푸짐', '배불', '넉넉', '리필', '배터', '혜자', '가득', '듬뿍', '양이', '양도', '양은'], # '많다' 삭제 (오해 방지)
    '#디저트맛집': ['디저트', '케이크', '빵', '베이커리', '커피', '음료', '후식', '카페', '빙수'],

    # ----------------------------------
    # [2] 분위기 & 뷰 (감성)
    # ----------------------------------
    '#분위기깡패': ['분위기', '인테리어', '감성', '무드', '예쁘', '고급', '느낌'],
    '#뷰맛집': ['뷰', '전망', '경치', '창가', '통유리', '바다', '산', '한강', '탁트인'],
    '#야경명소': ['야경', '밤', '조명', '불빛', '저녁', '어두워'],
    '#사진명소': ['사진', '포토', '인생샷', '찍기', '샷', '셀카', '찍었', '인스타'],
    '#힙한': ['힙', '트렌드', '요즘', '핫', 'MZ', '젊은'],
    '#조용한': ['조용', '한적', '여유', '차분', '공부', '집중', '시끄럽지'],
    '#레트로': ['옛날', '추억', '전통', '노포', '역사', '고풍', '빈티지'],

    # ----------------------------------
    # [3] 편의성 & 시설
    # ----------------------------------
    '#주차편함': ['주차', '발렛', '주차장', '공영', '차댈'],
    '#대중교통편리': ['역', '버스', '지하철', '접근', '교통', '뚜벅이'],
    '#넓은공간': ['넓다', '쾌적', '단체', '회식', '자리', '2층', '테이블', '넓어'],
    '#청결한': ['깨끗', '청결', '깔끔', '위생', '관리', '화장실', '먼지'],
    '#친절해요': ['친절', '서비스', '응대', '사장님', '직원', '알바', '상냥', '설명'],
    '#웨이팅필수': ['웨이팅', '대기', '줄', '오픈런', '예약', '기다렸', '기다리', '사람이 많', '사람많', '손님', '북적', '붐비', '인파'], # 핵심 보강!
    '#혼자가기좋은': ['혼자', '1인', '혼밥', '바테이블', '눈치', '다찌', '혼술'],
    '#직원친절': ['친절', '서비스', '응대', '사장님', '직원', '상냥'], # (중복이지만 유지)
    '#무료입장': ['무료', '공짜', '입장료', '비용없음', '돈안'],
    
    # ----------------------------------
    # [4] 누구와 함께? (타겟)
    # ----------------------------------
    '#데이트코스': ['데이트', '커플', '연인', '여친', '남친', '기념일', '소개팅'],
    '#가족과함께': ['가족', '부모님', '어르신', '효도', '모시고'],
    '#아이와함께': ['아이', '애기', '유모차', '키즈', '교육', '체험', '아들', '딸'],
    '#반려동물동반': ['애견', '강아지', '댕댕이', '고양이', '반려', '동반', '펫', '목줄'],
    '#친구랑': ['친구', '우정', '수다', '모임'],

    # ----------------------------------
    # [5] 활동 & 특징
    # ----------------------------------
    '#힐링산책': ['산책', '걷기', '공원', '숲', '나무', '자연', '등산', '바람'],
    '#빵지순례': ['성심당', '빵', '튀소', '부추빵', '명란바게트', '빵집'],
    '#실내데이트': ['실내', '비', '에어컨', '따뜻', '시원', '쇼핑', '몰'],
    '#이색체험': ['체험', '구경', '볼거리', '전시', '공연', '놀거리', '박물관'],
    '#카공하기좋은': ['콘센트', '노트북', '공부', '작업', '와이파이', '스터디', '책']
}

# (자동 생성)
FINAL_TAGS = list(TAG_MAPPING.keys())
print(f"🎯 AI가 학습할 태그 목록 (총 {len(FINAL_TAGS)}개): {FINAL_TAGS}")

# ---------------------------------------------------------
# 2. 데이터 로드
# ---------------------------------------------------------
file_name = 'Ai/data/total_merged_data.csv'
try:
    df = pd.read_csv(file_name)
    print(f"✅ 데이터 로드 성공: {len(df)}개 리뷰")
except FileNotFoundError:
    print("❌ 파일을 찾을 수 없습니다.")
    exit()

# ---------------------------------------------------------
# 3. 라벨링 함수 (Multi-hot Encoding)
# ---------------------------------------------------------
def create_label(token_str):
    try:
        tokens = ast.literal_eval(token_str)
        if not isinstance(tokens, list): tokens = []
    except:
        tokens = []
    
    label_vector = [0] * len(FINAL_TAGS)
    
    for i, tag in enumerate(FINAL_TAGS):
        keywords = TAG_MAPPING[tag]
        for keyword in keywords:
            # 💡 수정: 단순히 in 만 쓰면 '양이'가 '고양이'에 걸릴 수 있음.
            # 정확도를 위해 token 전체 일치 또는 포함 여부를 꼼꼼히 체크
            if any(keyword in t for t in tokens): 
                label_vector[i] = 1
                break 
                
    return label_vector

# ---------------------------------------------------------
# 4. 실행 및 저장
# ---------------------------------------------------------
print("🚀 라벨링(정답지 생성) 진행 중...")
df['label'] = df['tokenized_words'].apply(create_label)

# 1. CSV 저장 (학습용)
output_name = 'Ai/data/final_dataset_for_ai.csv'
df.to_csv(output_name, index=False, encoding='utf-8-sig')
print(f"\n✅ 최종 학습 데이터셋 저장 완료: {output_name}")

# 2. JSON 저장 (태그 순서)
with open("Ai/src/preprocessing/tags.json", "w", encoding="utf-8") as f:
    json.dump(FINAL_TAGS, f, ensure_ascii=False)
print("✅ 태그 순서 지도 저장 완료: tags.json")